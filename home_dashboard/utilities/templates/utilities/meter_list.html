{% extends 'base.html' %}
{% load static %}

{% block main %}

    <main role="main" class="container">

        <div class="card">
            <table class="table table-hover" id='table-meter-rest'>
                <thead>
                    <th class='columnheader' order=-1 id='id'>#</th>
                    <th class='columnheader' order=-1 id='meter_name'>Meter name</th>
                    <th class='columnheader' order=-1 id='meter_unit'>Unit</th>
                    <th></th>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        {% if perms.utilities.add_meter %}
            {% include 'utilities/snippets/add_meter_modal.html' %}
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#newMeterModal">
              Add new Meter
            </button>
        {% endif %}
        {% if perms.utilities.delete_meter %}
            {% include 'utilities/snippets/delete_meter_modal.html' %}
        {% endif %}
        {% if perms.utilities.change_meter %}
            {% include 'utilities/snippets/edit_meter_modal.html' %}
        {% endif %}

    </main>

{% endblock %}

{% block script %}
    <script>
        const ADD = {{ perms.utilities.add_meter_modal|lower }};
        const CHANGE = {{ perms.utilities.change_meter|lower }};
        const DELETE = {{ perms.utilities.delete_meter|lower }};
        const METERURL = '/api/v1/meter';
        const FORMAT = 'json';
        const INPUTNAMEDELETE = '#meterNameInputDelete';
        const DELETEMODALNAME = '#deleteMeterModal';

        function delMeter(id, name) {
            $(INPUTNAMEDELETE).val(id);
            $('#deleteMeterModalMeterId').val(id);
            $('#deleteMeterModalMetername').html(name);
            $(DELETEMODALNAME).modal('show');
        }

        clearMeterTable = () => $('#table-meter-rest > tbody > tr').remove();

        function buildMetertable(data) {
            clearMeterTable();
            if (data == null || data == '') {
                $('#table-meter-rest > tbody:last')
                    .append('<tr><td colspace=4>No ' +
                            'meters yet</td></tr>');
            }
            $.each(data, (i, item) => {
                let edit = CHANGE ? ' <a onclick="editmeter(' + item.id + ', \'' + item.meter_name + '\', \'' + item.meter_unit + '\')"><img src="{% static 'open-iconic-master/svg/wrench.svg' %}" style="width:1em"</a>' : '';
                let del = DELETE ? ' <a onclick="delMeter(' + item.id + ', \'' + item.meter_name + '\')"><img src="{% static 'open-iconic-master/svg/trash.svg' %}" style="width:1em"</a>' : '';
                $('#table-meter-rest > tbody:last')
                    .append('<tr>' +
                            '<td>' + item.id+'.</td>'+
                            '<td>' + item.meter_name+ '</td>'+
                            '<td>' + item.meter_unit+ '</td>' +
                            '<td>' + edit + del + '</td>' +
                            '</tr>');
            });
        }

        function getMeters(sort_by){
            $.ajax({
                url: METERURL + '/?format=' + FORMAT + '&ordering='+sort_by
            }).then((data) => {
                let results = data.results;
                buildMetertable(results);
            });
        }

        //Sort when clicking on a column header
        $('.columnheader').click((ev) => {
            order = ev.target.getAttribute('order');
            order_by = order == 1 ? '-'+ev.target.id : ev.target.id;
            getMeters(order_by);
            ev.target.setAttribute('order', order * -1);
        });

        $(document).ready(() => {
            getMeters('id');
        });
    </script>
{% endblock %}
